<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
    @if (giftService.isRaffleLocked()) {
  <p-message 
    severity="error" 
    text="Sales closed! Raffle completed. Further purchases are disabled."
    styleClass="w-full mt-2">
  </p-message>
    }

<div class="basket-container" dir="ltr">
    <p-table [value]="basketItems" styleClass="p-datatable-sm">
        <ng-template pTemplate="body" let-item>
            <tr class="border-bottom-1 border-100">
                
                <td class="text-center" style="width: 30%">
                    @if (item.giftImage) {
                        <img [src]="environment.serverUrl +'/'+ item.giftImage" 
                             [alt]="item.giftTitle" 
                             class="w-4rem h-4rem border-round shadow-1 mb-1 mt-2" />
                    } @else {
                        <img src="assets/images/default-gift.png" 
                             alt="Default Gift Image" 
                             class="w-4rem h-4rem border-round shadow-1 mb-1 mt-2" />         
                    }
                    <div class="text-900 font-bold text-xs uppercase">
                        {{ item.giftTitle || 'Gift #' + item.giftId }}
                    </div>
                </td>

                <td class="text-center" style="width: 50%">
                    <div class="flex align-items-center justify-content-center gap-3">
                        <div class="flex align-items-center gap-2">
                            <button pButton icon="pi pi-minus" 
                            [disabled]="giftService.isRaffleLocked()"
                                    class="p-button-rounded p-button-text p-button-sm bg-gray-100 text-700"
                                    (click)="updateQuantity(item, -1)"
                                    [disabled]="item.quantity <= 1"></button>
                            
                            <span class="font-bold text-lg w-2rem text-center">{{item.quantity}}</span>
                            
                            <button pButton icon="pi pi-plus" 
                            [disabled]="giftService.isRaffleLocked()"
                                    class="p-button-rounded p-button-text p-button-sm bg-gray-100 text-700"
                                    (click)="updateQuantity(item, 1)"></button>
                        </div>

                        @if (item.giftTicketPrice) {
                            <div class="text-primary font-semibold text-lg border-left-1 border-200 pl-3">
                                ${{ item.giftTicketPrice * item.quantity }}
                            </div>
                        }
                    </div>
                </td>

                <td class="text-center" style="width: 20%">
                    <button pButton icon="pi pi-trash" 
                            class="p-button-rounded p-button-danger p-button-text"
                            (click)="removeFromBasket(item.id)"></button>
                </td>
            </tr>
        </ng-template>
    </p-table>

    @if (basketItems.length === 0) {
        <div class="flex flex-column align-items-center justify-content-center p-6 text-400">
            <i class="pi pi-shopping-bag text-6xl mb-3 opacity-50"></i>
            <span class="text-xl font-medium">Your basket is empty</span>
            <p class="text-sm mt-2">Looks like you haven't added anything yet.</p>
        </div>
    }

    @if (basketItems.length > 0) {
        <div class="mt-5 p-4 surface-card border-round-xl shadow-2 border-1 border-100">
            <div class="flex justify-content-between align-items-center mb-4">
                <span class="text-700 font-bold text-lg">Total Tickets:</span>
                <span class="text-900 font-bold text-2xl text-primary">
                    {{ calculateTickets() }}
                </span>
            </div>

            <div class="flex justify-content-between align-items-center mb-4">
                <span class="text-700 font-bold text-lg">Total Price:</span>
                <span class="text-900 font-bold text-2xl text-primary">${{ calculateTotal() }}</span>
            </div>

            <button pButton label="Checkout Now" (click)="confirmBuying()"
            [disabled]="giftService.isRaffleLocked()"
                    class="w-full p-button-rounded p-button-primary shadow-2 font-bold py-3 uppercase">
            </button>
        </div>
    }
</div>

<p-dialog [(visible)]="showSuccessDialog" 
          [modal]="true" 
          [closable]="true" 
          [appendTo]="'body'"
          [style]="{width: '450px'}" 
          styleClass="success-dialog">
    
    <div class="flex flex-column align-items-center text-center p-4">
        <div class="bg-green-100 border-circle flex align-items-center justify-content-center mb-4 pulse-animation" 
             style="width: 80px; height: 80px">
            <i class="pi pi-check text-green-500 text-5xl"></i>
        </div>

        <h1 class="text-4xl font-bold text-900 mb-2">Congratulations!</h1>
        <p class="text-xl text-600 mb-4">Your purchase completed successfully!</p>
         <p class="text-700 m-0 text-lg font-bold">Wait for good news...</p>

        <div class="surface-100 border-round p-3 mb-4 w-full mb-30">
            <p class="text-700 m-0 font-bold text-green-600">Thank you very much for your generous donation!</p>
        </div>

        <button pButton label="Great, thanks!" 
                class="p-button-success p-button-lg w-full font-bold" 
                (click)="showSuccessDialog = false">
        </button>
    </div>
</p-dialog>

<style>
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(74, 222, 128, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
    }
</style>